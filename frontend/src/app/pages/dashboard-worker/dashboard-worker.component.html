<div class="dashboard-container">
  <h1 class="dashboard-title">Worker Dashboard</h1>
  <p class="dashboard-subtitle">Welcome, {{ userName }}! Here are your active tasks.</p>

  <div *ngIf="errorMessage" class="general-error-message">{{ errorMessage }}</div>
  <div *ngIf="isLoading" class="loading-spinner">Loading your tasks...</div>
  <div *ngIf="!isLoading && myTasks.length === 0 && !errorMessage" class="no-data">
    You have no active tasks. Well done!
  </div>

  <div class="task-list" *ngIf="!isLoading && myTasks.length > 0">
    <div class="task-card" *ngFor="let task of myTasks" [ngClass]="task.status.replace(' ', '-').toLowerCase()">
      <div class="task-details">
        <h4>{{ task.taskDescription }}</h4>
        <p><strong>Crop:</strong> {{ task.cropId?.cropName || 'N/A' }}</p>
        <p><strong>Due:</strong> {{ task.dueDate | date:'mediumDate' }}</p>
        <p><strong>Status:</strong> <span class="status-badge">{{ task.status }}</span></p>
      </div>
      <div class="task-actions">
        <!-- Show 'Start' button only if task is Pending -->
        <button *ngIf="task.status === 'Pending'" class="start-button" (click)="startTask(task._id)">
          Start Task
        </button>
        <!-- Show 'Complete' button only if task is In Progress -->
        <button *ngIf="task.status === 'In Progress'" class="complete-button" (click)="openCompletionModal(task)">
          Mark as Completed
        </button>
      </div>
    </div>
  </div>

  <!-- COMPLETION NOTE MODAL -->
  <div class="form-overlay" *ngIf="isNoteModalVisible">
    <div class="form-modal">
      <h2>Complete Task</h2>
      <p>You are about to complete: <strong>{{ taskToComplete?.taskDescription }}</strong></p>
      <form [formGroup]="completionForm" (ngSubmit)="submitCompletion()">
        <div class="form-group">
          <label for="completionNote">Add a note (optional)</label>
          <textarea id="completionNote" formControlName="completionNote" rows="3" placeholder="e.g., Finished, but one tool broke."></textarea>
        </div>
        <div class="form-actions">
          <button type="button" class="btn-secondary" (click)="closeCompletionModal()">Cancel</button>
          <button type="submit" class="complete-button">Confirm Completion</button>
        </div>
      </form>
    </div>
  </div>
</div>